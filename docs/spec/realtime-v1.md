# Arc Realtime Protocol (WS) â€” v1

## Goals (Phase 1)
- Real-time messaging over WebSocket between Flutter clients and Go server.
- A single conversation container supports both direct (1-to-1) and group chats.
- Stable ordering and de-duplication (idempotency) matching what users see.
- Minimal delivery/read indicators (one-tick / two-tick).
- Security baseline appropriate for MVP, designed for future full auth.

## Terminology
- **Conversation**: The container for messages and members.
  - kind: `direct` (1:1), `group` (many:many), `room` (open/public room mode).
  - visibility: `public` or `private`.
- **Member**: A user identity participating in a conversation.
- **Message**: A chat item. For Phase 1, `text` and `system` are defined.
- **Client Message ID**: An ID generated by the client to ensure idempotency.
- **Server Sequence (seq)**: A monotonically increasing number per conversation used for ordering.

## Transport
- WebSocket endpoint: `GET /ws`
- Subprotocol: `arc.realtime.v1` (recommended)
- Payload encoding: JSON

## Envelope
All frames MUST be JSON objects with the following top-level shape:

{
  "v": 1,
  "type": "string",
  "id": "string",
  "ts": "RFC3339 timestamp",
  "payload": {}
}

## Event Names (v1)
- hello
- hello.ack
- conversation.join
- message.send
- message.ack
- message.new
- message.read
- system.new
- error

## Connection State Machine (Client)
1. Connect WS.
2. Send hello.
3. Receive hello.ack.
4. Join a conversation via conversation.join.
5. Send messages via message.send.
6. Receive new messages via message.new / system.new.
7. On disconnect: reconnect and re-hello; optionally resync (future).

## Access Control (PR-010)
- `conversation.join`:
  - `public` conversation: join is allowed.
  - `private` conversation: user must already be a member.
- `message.send` and `conversation.history.fetch`:
  - membership is always required.

## Authentication (MVP Baseline)
- Client sends an auth token in hello.payload.token.
- Server MUST reject unauthenticated clients with error and close the connection.

## IDs and Ordering
- conversation_id: UUIDv7 or ULID
- client_msg_id: ULID
- server_msg_id: UUIDv7
- Server assigns seq per conversation.
- Clients render messages ordered by seq.

## Limits
- Max frame size: 64KB
- Max message length: 4000 chars
- Rate limit: 20 events / 10 seconds
