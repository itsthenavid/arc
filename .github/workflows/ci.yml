name: CI

on:
  pull_request:
  push:
    branches: ["main"]

permissions:
  contents: read

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  go:
    name: Go (fmt/lint/test + postgres)
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: arc
          POSTGRES_USER: arc
          POSTGRES_PASSWORD: arc_dev_password
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U arc -d arc"
          --health-interval=5s
          --health-timeout=3s
          --health-retries=30

    env:
      ARC_HTTP_ADDR: "127.0.0.1:8080"
      ARC_DATABASE_URL: "postgres://arc:arc_dev_password@127.0.0.1:5432/arc?sslmode=disable"

      # Keep lint deterministic in CI.
      GOLANGCI_LINT_VERSION: "v2.0.2"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          # Use server/go/go.mod for Go version to avoid drift.
          go-version-file: server/go/go.mod
          cache: true
          cache-dependency-path: |
            server/go/go.sum
            shared/go.sum
            go.work.sum

      # Install golangci-lint binary on the runner (your scripts call it).
      # We only use the action as an installer and keep lint logic in tools/scripts/lint.sh.
      - name: Setup golangci-lint
        uses: golangci/golangci-lint-action@v7
        with:
          version: ${{ env.GOLANGCI_LINT_VERSION }}
          # Install only; do not run lint here (single source of truth = tools/scripts/lint.sh).
          args: --version
          # Ensure module context is fine even if go.work exists.
          working-directory: server/go

      - name: Install Postgres client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Wait for Postgres
        env:
          PGPASSWORD: arc_dev_password
        run: |
          for i in {1..60}; do
            pg_isready -h 127.0.0.1 -p 5432 -U arc -d arc && exit 0
            sleep 1
          done
          echo "Postgres did not become ready in time"
          exit 1

      - name: Apply DB schema
        env:
          PGPASSWORD: arc_dev_password
        run: |
          psql "$ARC_DATABASE_URL" -v ON_ERROR_STOP=1 -f infra/db/atlas/schema.sql

      - name: Quality gates (fmt)
        run: bash tools/scripts/fmt.sh

      - name: Quality gates (lint)
        run: bash tools/scripts/lint.sh

      - name: Quality gates (test)
        run: bash tools/scripts/test.sh

  flutter:
    name: Flutter (test)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.38.7"
          channel: "stable"
          cache: true

      - name: Flutter tests
        working-directory: client/flutter
        run: flutter test
